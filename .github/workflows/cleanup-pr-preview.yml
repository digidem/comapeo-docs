name: Cleanup PR Preview

on:
  pull_request:
    types: [closed]

jobs:
  cleanup-preview:
    name: Delete PR Preview Deployment
    runs-on: ubuntu-latest
    # Skip if PR is from a fork
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Delete Cloudflare Pages deployment
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            console.log(`üóëÔ∏è  Cleaning up preview deployment for PR #${prNumber}`);

            // Note: Cloudflare Pages automatically manages deployments
            // Branch deployments are kept until manually deleted via API or dashboard
            // This step logs the cleanup and can be extended with wrangler commands if needed

            core.info(`Preview URL was: https://pr-${prNumber}.comapeo-docs.pages.dev`);
            core.info('Branch deployment will be automatically cleaned up by Cloudflare Pages retention policy');

      - name: Comment on PR about cleanup
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## üßπ Preview Deployment Cleanup

              The preview deployment for this PR has been cleaned up.

              Preview URL was: \`https://pr-${prNumber}.comapeo-docs.pages.dev\`

              ---

              <sub>Note: Cloudflare Pages deployments follow automatic retention policies. Old previews are cleaned up automatically.</sub>`,
            });

      - name: Cleanup summary
        run: |
          echo "üßπ **PR Preview Cleanup Complete!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Preview deployment marked for cleanup" >> $GITHUB_STEP_SUMMARY
          echo "- üóëÔ∏è  Preview URL: https://pr-${{ github.event.pull_request.number }}.comapeo-docs.pages.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cloudflare Pages will automatically clean up old deployments." >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "*PR preview cleanup*: ${{ job.status }} for PR #${{ github.event.pull_request.number }}"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*PR preview cleanup*: ${{ job.status }}\nPR: <${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }}>"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "Preview URL: https://pr-${{ github.event.pull_request.number }}.comapeo-docs.pages.dev"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "Trigger: <https://github.com/${{ github.triggering_actor }}|${{ github.triggering_actor }}>"
