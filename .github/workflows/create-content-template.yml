name: Create Content Template

on:
  workflow_dispatch:
    inputs:
      title:
        description: "Title for the new content template"
        required: false
        type: string
        default: "New Content"
  repository_dispatch:
    types:
      - create-content-template

jobs:
  create-template:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2

      - name: Install dependencies
        run: bun i

      - name: Get title from inputs
        id: get-title
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "title=${{ github.event.inputs.title }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "title=${{ github.event.client_payload.title }}" >> $GITHUB_OUTPUT
          else
            echo "title=New Content Template" >> $GITHUB_OUTPUT
          fi

      - name: Validate title
        run: |
          if [ -z "${{ steps.get-title.outputs.title }}" ]; then
            echo "❌ Error: No title provided"
            exit 1
          fi
          echo "✅ Creating template with title: '${{ steps.get-title.outputs.title }}'"

      - name: Create Content Template
        run: bun scripts/notion-create-template "${{ steps.get-title.outputs.title }}"
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          DATABASE_ID: ${{ secrets.DATABASE_ID }}

      - name: Report Success
        if: success()
        run: |
          echo "🎉 Content template '${{ steps.get-title.outputs.title }}' created successfully!"
          echo "📄 Two pages have been created:"
          echo "  1. Main page: '${{ steps.get-title.outputs.title }}'"
          echo "  2. English child page: '${{ steps.get-title.outputs.title }} (English)'"
          echo "📊 Both pages have 'Not started' status"
          echo "🔢 Order number assigned automatically"

      - name: Report Failure
        if: failure()
        run: |
          echo "💥 Failed to create content template '${{ steps.get-title.outputs.title }}'"
          echo "Please check the logs above for error details"
          exit 1

      - name: Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "*Create content template*: ${{ job.status }} ('${{ steps.get-title.outputs.title || 'New Content Template' }}')"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Create content template*: ${{ job.status }}\nTitle: `${{ steps.get-title.outputs.title || 'New Content Template' }}`"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "Trigger: <https://github.com/${{ github.triggering_actor }}|${{ github.triggering_actor }}>\nRun: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View logs>"
