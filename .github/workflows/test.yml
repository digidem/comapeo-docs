name: Test (Bun + Vitest)

on:
  # Avoid double-running on feature branches by only running push on main.
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      # Provide dummy key so OpenAI client construction doesn't fail in tests.
      OPENAI_API_KEY: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
        with:
          bun-version: latest

      - name: Checkout i18n content from content branch
        id: i18n_content
        shell: bash
        run: |
          if git checkout origin/content -- i18n/; then
            echo "has_i18n=true" >> "$GITHUB_OUTPUT"
            echo "✅ Loaded i18n content from origin/content."
          else
            echo "has_i18n=false" >> "$GITHUB_OUTPUT"
            echo "⚠️ origin/content checkout failed. Locale-dependent tests will be skipped."
          fi

      - name: Install dependencies
        run: bun install

      - name: Rebuild sharp for CI environment
        run: npm rebuild sharp

      - name: Run tests
        shell: bash
        run: |
          if [ "${{ steps.i18n_content.outputs.has_i18n }}" = "true" ]; then
            echo "✅ Running full test suite (including locale-dependent tests)."
            bun run test
          else
            echo "⚠️ Skipping locale-dependent tests because origin/content checkout failed."
            echo "Skipped: scripts/locale-parity.test.ts, scripts/verify-locale-output.test.ts"
            bunx vitest run --pool=threads --exclude scripts/locale-parity.test.ts --exclude scripts/verify-locale-output.test.ts
          fi
